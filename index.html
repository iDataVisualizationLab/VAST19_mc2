<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Map</title>
</head>

<style>
    #map{
        width:50%;
        display:inline-block;
    }
    #map .map path {
        fill: lightgrey;
        stroke: white;
    }
    div.tooltip {
        position:absolute;
        color: #000000;
        z-index:1000;
        background:rgba(255,255,255,0.5);
        padding:5px 10px;
        border-radius:5px;
        font-size:10px;
        width:180px;
        border:1px solid;
        -webkit-transform:translate(0,-50%);
        transform:translate(0,-50%);
        pointer-events:none;
    }
    .selected {
        fill: green;
    }
    .unselected{
        fill: lightgrey
    }
    #heatmap{
        float:right;
        width: 60%;
        height: 95%;
        margin: 0px 0px 0px 0.6%;
        padding: 10px;
        border-style: solid;
        border-color: lightgrey;
        overflow-y: scroll;
    }

</style>

<body>
<div id="map">
    <svg width="600px" height="600px">
        <g class="map"></g>
    </svg>
</div>
<div id="heatmap"></div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="js/heatmap.js"></script>

<script>
    var filelist = [];
    for ( i = 1; i < 20; i ++ )
    {
        var filename = "data/aggDataHeatmap/Region" + i + ".csv";
        filelist.push(d3.csv(filename));
    }

    var tsfilelist = [];
    for ( i = 1; i < 20; i ++ )
    {
        var tsfilename = "data/AggRegid/Region" + i + ".csv";
        tsfilelist.push(d3.csv(tsfilename));
    }

    Promise.all(filelist).then(files => {
        Promise.all( tsfilelist ).then( tsfiles => {
            var index = 1;
            var alldata = [];
            for (i = 0; i < files.length; i++) {
                files[i].forEach(d => {
                    d.Timestamp = parse(d.Timestamp);
                    d.Value = +d.Value;
                })
                alldata.push(files[i]);
            }
            draw_heatmap(alldata[index-1]);


            d3.json('data/StHimark.geojson').then(geojson => {
                const mapTip = d3.select("#map")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip");

                let width = 600, height = 600;
                let projection = d3.geoEquirectangular().scale(1).translate([0, 0]);

                let geoPath = d3.geoPath()
                    .projection(projection);

                //Scaling and translating.
                let b = geoPath.bounds(geojson),
                    s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
                    t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

                projection.scale(s).translate(t);

                function draw_map(geojson) {
                    let u = d3.select('#map g.map')
                        .selectAll('path')
                        .data(geojson.features);

                    u.enter()
                        .append('path')
                        .attr('d', geoPath)
                        .attr("id", d=>removeWhitespace(d.properties.Nbrhood))
                        .classed("unselected",d=>d.properties.Nbrhood == "Palace Hills")
                        .classed("selected", d=>d.properties.Nbrhood == "Palace Hills")
                        .on("click", d=>draw_heatmap(this.id))
                        .on("mouseover", mouseover)
                        .on("mousemove", mousemove)
                        .on("mouseleave", mouseleave)

                    debugger
                    ;
                    u.enter()
                        .append("svg:text")
                        .text(d => d.properties.Id + " " + d.properties.Nbrhood)
                        .style("display", "block")
                        .attr("x", d => geoPath.centroid(d)[0])
                        .attr("y", d => geoPath.centroid(d)[1])
                        .attr("text-anchor", "middle")
                        .attr("font-size", "8pt");


                }

                draw_map(geojson);

                function removeWhitespace(str){
                    return str.replace(/\s+/g, '');
                }

                function mouseover() {
                    mapTip
                        .transition()
                        .duration(500)
                        .style("opacity", 1)
                    d3.select(this)
                    // .style("stroke", "black")
                        .style("opacity", 0.5)
                }

                function mousemove(d) {
                    mapTip
                        .html("Region: " + d.properties.Nbrhood + "<br>"
                            + "ID  : " + d.properties.Id)
                        .style("left", (d3.mouse(this)[0] + 30) + "px")
                        .style("top", (d3.mouse(this)[1]) + 20 + "px")
                }

                function mouseleave() {
                    mapTip
                        .transition()
                        .duration(500)
                        .style("opacity", 0)
                    d3.select(this)
                    // .style("stroke", "black")
                        .style("opacity", 1)
                }

                function selected() {
                    d3.select(".selected").classed("selected",false);
                    d3.select(this).classed("selected",true);
                }

            })



        });
    });





</script>
</body>
</html>