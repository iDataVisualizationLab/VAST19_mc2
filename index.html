<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Map</title>
</head>

<style>
    #map{
        width:50%;
        margin:auto;
        display:inline-block;
        float:left;
    }
    #map .map path {
        fill: lightgrey;
        stroke: white;
    }
    div.tooltip {
        position:absolute;
        color: #000000;
        z-index:1000;
        background:rgba(255,255,255,0.5);
        padding:5px 10px;
        border-radius:5px;
        font-size:10px;
        width:180px;
        border:1px solid;
        -webkit-transform:translate(0,-50%);
        transform:translate(0,-50%);
        pointer-events:none;
    }
    .active {
        fill: green;
    }
    .inactive{
        fill: lightgrey
    }
    #heatmap{
        float:left;
        width: 45%;
        height: 900px;
        margin:auto;
        padding: 10px;
        border-style: solid;
        border-color: lightgrey;
        overflow:auto;
    }

</style>

<body>
<div id="map">
    <svg width="600px" height="600px">
        <g class="map"></g>
    </svg>
</div>
<div id="heatmap"></div>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="js/heatmap.js"></script>

<script>
    var filelist = [];
    for ( i = 1; i < 20; i ++ )
    {
        var filename = "data/aggDataHeatmap/Region" + i + ".csv";
        filelist.push(d3.csv(filename));
    }

    var tsfilelist = [];
    for ( i = 1; i < 20; i ++ )
    {
        var tsfilename = "data/AggRegid/Region" + i + ".csv";
        tsfilelist.push(d3.csv(tsfilename));
    }

    Promise.all(filelist).then(files => {
        Promise.all( tsfilelist ).then( tsfiles => {
            var index = 1;
            var alldata = [];
            for (i = 0; i < files.length; i++) {
                files[i].forEach(d => {
                    d.Timestamp = parse(d.Timestamp);
                    d.Value = +d.Value;
                })
                alldata.push(files[i]);
            }
            //initialize heatmap
            draw_heatmap(alldata[index-1]);

            debugger
            const mapTip = d3.select("#map")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip");

            d3.json('data/StHimark.geojson').then(geojson => {

                let width = 500, height = 500;
                let projection = d3.geoEquirectangular().scale(1).translate([0, 0]);

                let geoPath = d3.geoPath()
                    .projection(projection);

                //Scaling and translating.
                let b = geoPath.bounds(geojson),
                    s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
                    t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

                projection.scale(s).translate(t);
                let regionNameList =['Palace Hills', 'Northwest', 'Old Town', 'Safe Town', 'Southwest', 'Downtown', 'Wilson Forest', 'Scenic-Vista', 'Broadview', 'Chapparal', 'Terrapin Springs', 'Pepper Mill', 'Cheddar-ford', 'Easton', 'Weston', 'Southton', 'Oak Willow', 'East Parton', 'West Parton'];
                let staticLocation = [[0.15689, -119.9594], [0.15109, -119.90952], [0.1218, -119.9043],[0.18299, -119.85558], [0.04147, -119.82861], [0.20764, -119.81556], [0.15979, -119.80715],[0.1218, -119.79265], [0.16849, -119.79033]];
                let hospitalLocation = [[0.180960, -119.959400], [0.153120, -119.915900], [0.151090, -119.909520], [0.121800, -119.904300], [0.134560, -119.883420], [0.182990, -119.855580], [0.041470, -119.828610], [0.065250, -119.744800]];

                function draw_map(geojson) {
                    let u = d3.select('#map g.map')
                        .selectAll('path')
                        .data(geojson.features);

                    u.enter()
                        .append('path')
                        .attr('d', geoPath)
                        .attr("id", d=>removeWhitespace(d.properties.Nbrhood))
                        .attr("class", "inactive")
                        // .classed("inactive",d,i=>d.properties.Nbrhood != "Palace Hills")
                        // .classed("active", d=>d.properties.Nbrhood == "Palace Hills")
                        .on("click", d=> {
                            // let id = removeWhitespace(d.properties.Nbrhood);
                            // let heatmapId =
                            // let selectedHeatmap = d3.select("#heatmap").select("#")
                            // let selectedRegion = d3.selece("#map").select("#" + id);
                            // let active =
                            if (d.properties.Nbrhood == "Palace Hills")
                                draw_heatmap(alldata[0]);
                            else if (d.properties.Nbrhood == "Northwest")
                                draw_heatmap(alldata[1]);
                            else if(d.properties.Nbrhood == "Old Town")
                                draw_heatmap(alldata[2]);
                            else if(d.properties.Nbrhood == "Safe Town")
                                draw_heatmap(alldata[3]);
                            else if(d.properties.Nbrhood == "Southwest")
                                draw_heatmap(alldata[4]);
                            else if(d.properties.Nbrhood == "Downtown")
                                draw_heatmap(alldata[5]);
                            else if(d.properties.Nbrhood == "Wilson Forest")
                                draw_heatmap(alldata[6]);
                            else if(d.properties.Nbrhood == "Scenic Vista")
                                draw_heatmap(alldata[7]);
                            else if(d.properties.Nbrhood == "Broadview")
                                draw_heatmap(alldata[8]);
                            else if(d.properties.Nbrhood == "Chapparal")
                                draw_heatmap(alldata[9]);
                            else if(d.properties.Nbrhood == "Terrapin Springs")
                                draw_heatmap(alldata[10]);
                            else if(d.properties.Nbrhood == "Pepper Mill")
                                draw_heatmap(alldata[11]);
                            else if(d.properties.Nbrhood == "Cheddarford")
                                draw_heatmap(alldata[12]);
                            else if(d.properties.Nbrhood == "Easton")
                                draw_heatmap(alldata[13]);
                            else if(d.properties.Nbrhood == "Weston")
                                draw_heatmap(alldata[14]);
                            else if(d.properties.Nbrhood == "Southton")
                                draw_heatmap(alldata[15]);
                            else if(d.properties.Nbrhood == "Oak Willow")
                                draw_heatmap(alldata[16]);
                            else if(d.properties.Nbrhood == "East Parton")
                                draw_heatmap(alldata[17]);
                            else if(d.properties.Nbrhood == "West Parton")
                                draw_heatmap(alldata[18]);
                        })
                        .on("mouseover", mouseover)
                        .on("mousemove", mousemove)
                        .on("mouseleave", mouseleave);



                    d3.csv("data/StaticSensorLocations.csv").then(location=>{
                        u.enter()
                            .data(location)
                            // .append("circle")
                            // .attr("id",d=>"static"+d["Sensor-id"])
                            // .attr("cx", d=> {
                            //     return projection([d.Long, d.Lat])[0];
                            // })
                            // .attr("cy", function(d) {
                            //     return projection([d.Long, d.Lat])[1];
                            // })
                            // .attr("r", "5px")
                            // .style("fill", "white");
                            .append("image")
                            .attr("class","statIcon")
                            .attr("width",10)
                            .attr("height",10)
                            .attr("xlink:href","Icon/meter.svg")
                            .attr("transform", d =>{ return "translate(" + projection([d.Long,d.Lat]) + ")"; })
                            .attr("cx", d=> {
                                return projection([d.Long, d.Lat])[0];
                            })
                            .attr("cy", function(d) {
                                return projection([d.Long, d.Lat])[1];
                            })
                            .on("mouseover",d=>mouseover);


                    });
                    u.enter()
                        .append("svg:text")
                        .text(d => d.properties.Id + " " + d.properties.Nbrhood)
                        .style("display", "block")
                        .attr("x", d => geoPath.centroid(d)[0])
                        .attr("y", d => geoPath.centroid(d)[1])
                        .attr("text-anchor", "middle")
                        .attr("font-size", "8pt");

                    debugger
                }

                draw_map(geojson);



            })

            function removeWhitespace(str){
                return str.replace(/\s+/g, '');
            }

            function mouseover() {
                mapTip
                    .transition()
                    .duration(500)
                    .style("opacity", 1)
                d3.select(this)
                // .style("stroke", "black")
                    .style("opacity", 0.5)
            }

            function mousemove(d) {
                mapTip
                    .html("Region: " + d.properties.Nbrhood + "<br>"
                        + "ID  : " + d.properties.Id)
                    .style("left", (d3.mouse(this)[0] + 30) + "px")
                    .style("top", (d3.mouse(this)[1]) + 20 + "px")
            }

            function mouseleave() {
                mapTip
                    .transition()
                    .duration(500)
                    .style("opacity", 0)
                d3.select(this)
                // .style("stroke", "black")
                    .style("opacity", 1)
            }



        });
    });



</script>
</body>
</html>